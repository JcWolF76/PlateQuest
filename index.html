<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlateQuest - License Plate Adventure</title>
    
    <!-- Firebase SDK - FIXED for Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            min-height: 100vh;
            color: #ecf0f1;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 48, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        body.dark {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d3748 50%, #1a1a1a 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        /* Splash Screen */
        #splash {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
        }

        .logo-container {
            position: relative;
            margin-bottom: 40px;
        }

        .logo {
            width: 250px;
            height: auto;
            border-radius: 20px;
            box-shadow: 
                0 0 30px rgba(52, 152, 219, 0.5),
                0 0 60px rgba(52, 152, 219, 0.3),
                inset 0 0 20px rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(52, 152, 219, 0.3);
            animation: logoGlow 3s ease-in-out infinite;
        }

        @keyframes logoGlow {
            0%, 100% { 
                box-shadow: 
                    0 0 30px rgba(52, 152, 219, 0.5),
                    0 0 60px rgba(52, 152, 219, 0.3),
                    inset 0 0 20px rgba(255, 255, 255, 0.1);
            }
            50% { 
                box-shadow: 
                    0 0 40px rgba(52, 152, 219, 0.8),
                    0 0 80px rgba(52, 152, 219, 0.5),
                    inset 0 0 30px rgba(255, 255, 255, 0.2);
            }
        }

        .welcome-text {
            background: linear-gradient(145deg, rgba(44, 62, 80, 0.9), rgba(52, 73, 94, 0.9));
            padding: 40px;
            border-radius: 25px;
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(15px);
            margin-bottom: 40px;
            max-width: 700px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .welcome-text h1 {
            font-size: 3em;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #3498db, #2980b9, #74b9ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(52, 152, 219, 0.5);
            font-weight: 900;
            letter-spacing: 2px;
        }

        .welcome-text p {
            font-size: 1.1em;
            line-height: 1.6;
            color: #bdc3c7;
        }

        .version-info {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 25px;
        }

        .badge {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: #3498db;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: bold;
            border: 1px solid rgba(52, 152, 219, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .start-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 22px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 
                0 10px 30px rgba(231, 76, 60, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(231, 76, 60, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 15px 40px rgba(231, 76, 60, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            background: linear-gradient(45deg, #ec7063, #e74c3c);
        }

        .version-links {
            margin-top: 30px;
        }

        .version-link {
            color: #3498db;
            text-decoration: none;
            padding: 12px 24px;
            background: linear-gradient(145deg, rgba(52, 73, 94, 0.6), rgba(44, 62, 80, 0.6));
            border-radius: 25px;
            transition: all 0.3s ease;
            margin: 0 10px;
            border: 1px solid rgba(52, 152, 219, 0.3);
            display: inline-block;
        }

        .version-link:hover {
            background: linear-gradient(145deg, rgba(52, 152, 219, 0.2), rgba(41, 128, 185, 0.2));
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        /* Game Interface */
        #game {
            display: none;
            background: linear-gradient(145deg, rgba(44, 62, 80, 0.95), rgba(52, 73, 94, 0.95));
            border-radius: 25px;
            backdrop-filter: blur(15px);
            box-shadow: 
                0 20px 50px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow: hidden;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .game-header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            border-bottom: 3px solid #3498db;
        }

        .game-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(52, 152, 219, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .game-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(52, 152, 219, 0.5);
        }

        .game-subtitle {
            opacity: 0.9;
            font-size: 16px;
        }

        .controls-section {
            padding: 30px;
            border-bottom: 1px solid rgba(52, 152, 219, 0.2);
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 10px;
            color: #3498db;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        select, input {
            padding: 15px 20px;
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 12px;
            font-size: 16px;
            background: linear-gradient(145deg, rgba(44, 62, 80, 0.8), rgba(52, 73, 94, 0.8));
            color: #ecf0f1;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 
                0 0 20px rgba(52, 152, 219, 0.3),
                inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
            background: linear-gradient(45deg, #5dade2, #3498db);
        }

        .btn-secondary {
            background: linear-gradient(145deg, #34495e, #2c3e50);
            color: #bdc3c7;
            border: 1px solid rgba(189, 195, 199, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(145deg, #4a6741, #34495e);
            transform: translateY(-1px);
            color: #ecf0f1;
        }

        /* Game Mode Selection */
        .mode-selection {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .mode-option {
            flex: 1;
            min-width: 200px;
        }

        .mode-option input[type="radio"] {
            display: none;
        }

        .mode-label {
            display: block;
            padding: 20px;
            background: linear-gradient(145deg, rgba(52, 73, 94, 0.8), rgba(44, 62, 80, 0.8));
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .mode-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .mode-option input[type="radio"]:checked + .mode-label {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.4);
        }

        .mode-option input[type="radio"]:checked + .mode-label::before {
            left: 100%;
        }

        /* Score Section */
        .score-section {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            padding: 30px;
            text-align: center;
            border-top: 3px solid #2ecc71;
            border-bottom: 3px solid #27ae60;
        }

        .score-display {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .progress-bar {
            background: rgba(0, 0, 0, 0.3);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 20px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .progress-fill {
            background: linear-gradient(90deg, #f1c40f, #f39c12);
            height: 100%;
            border-radius: 6px;
            transition: width 0.8s ease;
            width: 0%;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.5);
        }

        /* Enhanced sections for game modes */
        .contributor-section, .challenge-section {
            background: linear-gradient(145deg, rgba(39, 174, 96, 0.1), rgba(46, 204, 113, 0.1));
            border: 1px solid rgba(39, 174, 96, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .contributor-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin: 0 5px 5px 0;
        }

        .challenge-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(52, 73, 94, 0.6);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #bdc3c7;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
        }

        /* States Grid */
        .states-section {
            padding: 30px;
        }

        .states-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .state-card {
            background: linear-gradient(145deg, rgba(52, 73, 94, 0.9), rgba(44, 62, 80, 0.9));
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            animation: slideInUp 0.4s ease;
        }

        .state-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(52, 152, 219, 0.3);
            border-color: #3498db;
        }

        .state-card.selected {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border-color: #2ecc71;
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 35px rgba(39, 174, 96, 0.4);
        }

        .state-card.selected.collaborative {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            border-color: #2ecc71;
        }

        .challenge-mode-active .state-card.selected {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            border-color: #e74c3c;
        }

        .challenge-mode-active .state-card.selected::after {
            content: '⚡';
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 16px;
            animation: pulse 2s infinite;
        }

        .state-card .contributor-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .state-info {
            flex: 1;
        }

        .state-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .state-abbr {
            font-size: 14px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }

        .state-flag {
            width: 50px;
            height: 35px;
            border-radius: 8px;
            background: linear-gradient(145deg, #95a5a6, #7f8c8d);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #2c3e50;
            box-shadow: 
                0 3px 10px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .state-flag img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        /* Action Buttons */
        .actions-section {
            padding: 30px;
            border-top: 1px solid rgba(52, 152, 219, 0.2);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Share Modal */
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
        }

        .share-modal-content {
            background: linear-gradient(145deg, #2c3e50, #34495e);
            border-radius: 15px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            z-index: 1;
            color: white;
        }

        .share-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(52, 152, 219, 0.3);
        }

        .close-btn {
            background: none;
            border: none;
            color: #bdc3c7;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .share-body {
            padding: 25px;
        }

        .code-box, .url-box {
            background: rgba(52, 73, 94, 0.8);
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .code-box:hover, .url-box:hover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .code {
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 3px;
            display: block;
            margin-bottom: 5px;
        }

        .url {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            display: block;
            margin-bottom: 5px;
        }

        .copy-hint {
            font-size: 12px;
            color: #bdc3c7;
            opacity: 0.7;
        }

        .qr-code-container {
            text-align: center;
            margin: 20px 0;
        }

        .qr-placeholder {
            width: 120px;
            height: 120px;
            border: 2px solid #3498db;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            color: #2c3e50;
            font-size: 10px;
            text-align: center;
        }

        .share-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .share-actions .btn {
            flex: 1;
        }

        /* Share Section */
        .share-section {
            background: linear-gradient(145deg, rgba(44, 62, 80, 0.9), rgba(52, 73, 94, 0.9));
            padding: 30px;
            border-top: 1px solid rgba(52, 152, 219, 0.2);
            text-align: center;
        }

        .export-box {
            width: 90%;
            max-width: 600px;
            height: 120px;
            margin: 20px auto;
            padding: 20px;
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background: linear-gradient(145deg, rgba(44, 62, 80, 0.8), rgba(52, 73, 94, 0.8));
            color: #ecf0f1;
            resize: vertical;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* Loading overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 10000;
            animation: slideInToast 0.3s ease;
        }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10000;
            border: 1px solid #3498db;
        }

        /* Animations */
        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes celebrate {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                filter: brightness(1);
            }
            25% { 
                transform: scale(1.1) rotate(-3deg);
                filter: brightness(1.2);
            }
            50% { 
                transform: scale(1.15) rotate(0deg);
                filter: brightness(1.3);
            }
            75% { 
                transform: scale(1.1) rotate(3deg);
                filter: brightness(1.2);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideInToast {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .state-card.celebrating {
            animation: celebrate 0.8s ease;
        }

        .state-card:nth-child(even) {
            animation-delay: 0.1s;
        }

        .state-card:nth-child(3n) {
            animation-delay: 0.2s;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .states-grid {
                grid-template-columns: 1fr;
            }

            .input-row {
                flex-direction: column;
                align-items: stretch;
            }

            .mode-selection {
                flex-direction: column;
            }

            .actions-section {
                flex-direction: column;
            }

            .welcome-text h1 {
                font-size: 2.2em;
            }

            .logo {
                width: 200px;
            }

            .share-modal-content {
                width: 95%;
                margin: 10px;
            }
            
            .challenge-stats {
                grid-template-columns: 1fr;
            }
            
            .share-actions {
                flex-direction: column;
            }
            
            .code {
                font-size: 18px;
                letter-spacing: 2px;
            }
        }

        /* Steel textures and effects */
        .steel-texture {
            background: 
                linear-gradient(45deg, transparent 49%, rgba(255,255,255,0.1) 50%, transparent 51%),
                linear-gradient(-45deg, transparent 49%, rgba(0,0,0,0.1) 50%, transparent 51%);
            background-size: 20px 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Splash Screen -->
        <div id="splash">
            <div class="logo-container">
                <img src="platequest-final-logo.jpeg" alt="PlateQuest Logo" class="logo">
            </div>
            <div class="welcome-text">
                <h1>PlateQuest</h1>
                <p><strong>SINGLE PLAYER EDITION</strong></p>
                <p>The ultimate license plate spotting adventure! Find all 50 state plates, track your progress, and turn every road trip into an exciting quest.</p>
                <div class="version-info">
                    <span class="badge">🚗 Solo Adventure</span>
                    <span class="badge">👨‍👩‍👧‍👦 Family Mode</span>
                    <span class="badge">🏆 Challenge Mode</span>
                    <span class="badge">☁️ Cloud Sharing</span>
                    <span class="badge">📱 Mobile Optimized</span>
                    <span class="badge">💾 Auto Save</span>
                </div>
            </div>
            <button class="start-btn" id="startBtn">Start Your Quest! 🎯</button>
            <div class="version-links">
                <a href="multiplayer/index.html" class="version-link">👥 Try Multiplayer Version</a>
            </div>
            <p style="margin-top: 30px; opacity: 0.7; font-style: italic;">Created by JcWoLF76</p>
        </div>

        <!-- Game Interface -->
        <div id="game">
            <!-- Header -->
            <div class="game-header">
                <div class="game-title" id="gameTitle">PlateQuest Adventure</div>
                <div class="game-subtitle">Find all 50 state license plates!</div>
            </div>

            <!-- Controls -->
            <div class="controls-section steel-texture">
                <!-- Profile Controls -->
                <div class="control-group">
                    <label>👤 Player Profile</label>
                    <div class="input-row">
                        <select id="profileSelect" style="flex: 1; min-width: 200px;">
                            <option>Select Profile...</option>
                        </select>
                        <input type="text" id="newProfileInput" placeholder="Create new profile..." style="flex: 1; min-width: 200px;">
                        <button class="btn btn-primary" id="createProfileBtn">Create</button>
                        <button class="btn btn-secondary" id="deleteProfileBtn">Delete</button>
                    </div>
                </div>

                <!-- Trip Controls -->
                <div class="control-group">
                    <label>🗺️ Trip Adventure</label>
                    <div class="input-row">
                        <select id="tripSelect" style="flex: 1; min-width: 200px;">
                            <option>Select Trip...</option>
                        </select>
                        <input type="text" id="newTripInput" placeholder="Name your adventure..." style="flex: 1; min-width: 200px;">
                        <button class="btn btn-primary" id="createTripBtn">Create</button>
                    </div>
                </div>

                <!-- Game Mode -->
                <div class="control-group">
                    <label>🎮 Game Mode</label>
                    <div class="mode-selection">
                        <div class="mode-option">
                            <input type="radio" name="mode" value="solo" id="soloMode" checked>
                            <label for="soloMode" class="mode-label">
                                🚗 Solo Adventure
                                <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">Track your personal progress</div>
                            </label>
                        </div>
                        <div class="mode-option">
                            <input type="radio" name="mode" value="collab" id="collabMode">
                            <label for="collabMode" class="mode-label">
                                👥 Family Mode
                                <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">Everyone contributes, see who found what</div>
                            </label>
                        </div>
                        <div class="mode-option">
                            <input type="radio" name="mode" value="versus" id="versusMode">
                            <label for="versusMode" class="mode-label">
                                🏆 Challenge Mode
                                <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">Race against time, track records</div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Score Display -->
            <div class="score-section">
                <div class="score-display" id="scoreDisplay">Found 0 of 50 plates (0%)</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <!-- States Grid -->
            <div class="states-section">
                <h3 style="margin-bottom: 15px; color: #3498db; font-size: 24px;">🗺️ State License Plates</h3>
                <p style="color: #bdc3c7; margin-bottom: 25px; font-size: 16px;">Tap any state when you spot their license plate!</p>
                <div class="states-grid" id="statesGrid">
                    <!-- States will be populated by JavaScript -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="actions-section">
                <button class="btn btn-secondary" id="resetBtn">🔄 Reset Trip</button>
                <button class="btn btn-primary" id="shareBtn">📤 Share Trip</button>
                <button class="btn btn-secondary" id="importBtn">📥 Load Shared Trip</button>
                <button class="btn btn-secondary" id="exportBtn">📋 Export Backup</button>
                <button class="btn btn-secondary" id="darkModeBtn">🌙 Dark Mode</button>
            </div>

            <!-- Share Section -->
            <div class="share-section" id="shareSection" style="display: none;">
                <h3 style="color: #3498db; margin-bottom: 15px;">📤 Export Your Adventure</h3>
                <p style="color: #bdc3c7;">Copy this code to share or backup your progress:</p>
                <textarea class="export-box" id="exportBox" placeholder="Trip progress will appear here..." readonly></textarea>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" id="copyExportBtn">📋 Copy to Clipboard</button>
                    <button class="btn btn-secondary" id="hideShareBtn">❌ Close</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading...</div>
        </div>
    </div>

    <!-- Debug Panel (remove after testing) -->
    <div id="debugPanel" class="debug-panel" style="display: none;">
        <div><strong>🔧 Firebase Debug</strong></div>
        <div>Firebase SDK: <span id="firebaseStatus">❓</span></div>
        <div>Database: <span id="databaseStatus">❓</span></div>
        <div>Connection: <span id="connectionStatus">❓</span></div>
        <button onclick="testConnection()" style="margin-top: 5px; padding: 2px 6px; background: #3498db; color: white; border: none; border-radius: 3px;">Test</button>
        <button onclick="document.getElementById('debugPanel').style.display='none'" style="margin-top: 5px; padding: 2px 6px; background: #e74c3c; color: white; border: none; border-radius: 3px;">Hide</button>
    </div>

    <script>
        // Firebase Configuration - FIXED for Realtime Database
        const firebaseConfig = {
            apiKey: "AIzaSyADgN2_6yMeIuWRZxsXdlUUjmZEd_Rn9qQ",
            authDomain: "platequest-multiplayer.firebaseapp.com",
            databaseURL: "https://platequest-multiplayer-default-rtdb.firebaseio.com/",
            projectId: "platequest-multiplayer",
            storageBucket: "platequest-multiplayer.firebasestorage.app",
            messagingSenderId: "109596979102",
            appId: "1:109596979102:web:586740c408daec71af708f"
        };

        // State data with abbreviations for flag images
        const statesData = [
            { name: "Alabama", abbr: "AL" },
            { name: "Alaska", abbr: "AK" },
            { name: "Arizona", abbr: "AZ" },
            { name: "Arkansas", abbr: "AR" },
            { name: "California", abbr: "CA" },
            { name: "Colorado", abbr: "CO" },
            { name: "Connecticut", abbr: "CT" },
            { name: "Delaware", abbr: "DE" },
            { name: "Florida", abbr: "FL" },
            { name: "Georgia", abbr: "GA" },
            { name: "Hawaii", abbr: "HI" },
            { name: "Idaho", abbr: "ID" },
            { name: "Illinois", abbr: "IL" },
            { name: "Indiana", abbr: "IN" },
            { name: "Iowa", abbr: "IA" },
            { name: "Kansas", abbr: "KS" },
            { name: "Kentucky", abbr: "KY" },
            { name: "Louisiana", abbr: "LA" },
            { name: "Maine", abbr: "ME" },
            { name: "Maryland", abbr: "MD" },
            { name: "Massachusetts", abbr: "MA" },
            { name: "Michigan", abbr: "MI" },
            { name: "Minnesota", abbr: "MN" },
            { name: "Mississippi", abbr: "MS" },
            { name: "Missouri", abbr: "MO" },
            { name: "Montana", abbr: "MT" },
            { name: "Nebraska", abbr: "NE" },
            { name: "Nevada", abbr: "NV" },
            { name: "New Hampshire", abbr: "NH" },
            { name: "New Jersey", abbr: "NJ" },
            { name: "New Mexico", abbr: "NM" },
            { name: "New York", abbr: "NY" },
            { name: "North Carolina", abbr: "NC" },
            { name: "North Dakota", abbr: "ND" },
            { name: "Ohio", abbr: "OH" },
            { name: "Oklahoma", abbr: "OK" },
            { name: "Oregon", abbr: "OR" },
            { name: "Pennsylvania", abbr: "PA" },
            { name: "Rhode Island", abbr: "RI" },
            { name: "South Carolina", abbr: "SC" },
            { name: "South Dakota", abbr: "SD" },
            { name: "Tennessee", abbr: "TN" },
            { name: "Texas", abbr: "TX" },
            { name: "Utah", abbr: "UT" },
            { name: "Vermont", abbr: "VT" },
            { name: "Virginia", abbr: "VA" },
            { name: "Washington", abbr: "WA" },
            { name: "West Virginia", abbr: "WV" },
            { name: "Wisconsin", abbr: "WI" },
            { name: "Wyoming", abbr: "WY" }
        ];

        // Game state
        let currentProfile = null;
        let currentTrip = null;
        let selectedStates = [];
        let currentGameMode = 'solo';
        let database = null;  // CHANGED: using Realtime Database
        let cloudEnabled = false;
        let challengeStartTime = null;
        let challengeTimer = null;

        // Mode configurations
        const gameModes = {
            solo: {
                name: "Solo Adventure",
                description: "Track your personal progress",
                allowMultipleContributors: false,
                showPersonalStats: true,
                trackBestTimes: false
            },
            collab: {
                name: "Family Mode", 
                description: "Everyone contributes to shared progress",
                allowMultipleContributors: true,
                showPersonalStats: false,
                trackBestTimes: false
            },
            versus: {
                name: "Challenge Mode",
                description: "Track personal best and compete",
                allowMultipleContributors: false,
                showPersonalStats: true,
                trackBestTimes: true
            }
        };

        // DOM elements
        const splash = document.getElementById('splash');
        const game = document.getElementById('game');
        const profileSelect = document.getElementById('profileSelect');
        const tripSelect = document.getElementById('tripSelect');
        const statesGrid = document.getElementById('statesGrid');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const progressFill = document.getElementById('progressFill');
        const shareSection = document.getElementById('shareSection');
        const exportBox = document.getElementById('exportBox');

        // FIXED: Initialize Firebase for Realtime Database
        function initializeCloudSharing() {
            try {
                if (typeof firebase !== 'undefined') {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    database = firebase.database();  // CHANGED: using database() instead of firestore()
                    
                    // Test the connection
                    testFirebaseConnection().then(connected => {
                        if (connected) {
                            cloudEnabled = true;
                            showCloudFeatures();
                            console.log('✅ Cloud sharing enabled with Realtime Database');
                            updateDebugStatus();
                        } else {
                            cloudEnabled = false;
                            showOfflineFeatures();
                            console.warn('❌ Firebase connection failed');
                            updateDebugStatus();
                        }
                    });
                } else {
                    console.warn('Firebase SDK not loaded');
                    cloudEnabled = false;
                    showOfflineFeatures();
                    updateDebugStatus();
                }
            } catch (error) {
                console.warn('Cloud sharing unavailable:', error);
                cloudEnabled = false;
                showOfflineFeatures();
                updateDebugStatus();
            }
        }

        // Test function to verify connection
        async function testFirebaseConnection() {
            try {
                const snapshot = await database.ref('.info/connected').once('value');
                return snapshot.val() === true;
            } catch (error) {
                console.error('Firebase connection test failed:', error);
                return false;
            }
        }

        // Debug functions (remove after testing)
        function showDebugPanel() {
            document.getElementById('debugPanel').style.display = 'block';
            updateDebugStatus();
        }

        function updateDebugStatus() {
            document.getElementById('firebaseStatus').textContent = typeof firebase !== 'undefined' ? '✅' : '❌';
            document.getElementById('databaseStatus').textContent = database ? '✅' : '❌';
            
            if (database) {
                database.ref('.info/connected').once('value', (snapshot) => {
                    document.getElementById('connectionStatus').textContent = snapshot.val() ? '✅' : '❌';
                });
            } else {
                document.getElementById('connectionStatus').textContent = '❌';
            }
        }

        async function testConnection() {
            updateDebugStatus();
            if (database) {
                try {
                    const snapshot = await database.ref('.info/connected').once('value');
                    alert(`Connection test: ${snapshot.val() ? 'SUCCESS ✅' : 'FAILED ❌'}`);
                } catch (error) {
                    alert(`Connection test: FAILED ❌\n${error.message}`);
                }
            } else {
                alert('Database not initialized ❌');
            }
        }

        // Initialize game
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners
            document.getElementById('startBtn').addEventListener('click', startGame);
            document.getElementById('createProfileBtn').addEventListener('click', createProfile);
            document.getElementById('deleteProfileBtn').addEventListener('click', deleteProfile);
            document.getElementById('createTripBtn').addEventListener('click', createTrip);
            document.getElementById('resetBtn').addEventListener('click', resetTrip);
            document.getElementById('shareBtn').addEventListener('click', shareTrip);
            document.getElementById('importBtn').addEventListener('click', loadSharedTrip);
            document.getElementById('exportBtn').addEventListener('click', showExport);
            document.getElementById('darkModeBtn').addEventListener('click', toggleDarkMode);
            document.getElementById('copyExportBtn').addEventListener('click', copyExport);
            document.getElementById('hideShareBtn').addEventListener('click', hideShare);

            profileSelect.addEventListener('change', selectProfile);
            tripSelect.addEventListener('change', selectTrip);

            // Game mode listeners
            const modeInputs = document.querySelectorAll('input[name="mode"]');
            modeInputs.forEach(input => {
                input.addEventListener('change', function() {
                    if (this.checked) {
                        currentGameMode = this.value;
                        updateGameModeUI();
                        updateScore();
                    }
                });
            });

            // Initialize cloud features
            setTimeout(initializeCloudSharing, 1000);
            
            // Show debug panel temporarily
            setTimeout(showDebugPanel, 2000);
            
            // Check for shared trip in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('share')) {
                setTimeout(() => loadSharedTrip(), 1500);
            }

            // Initialize dark mode from saved preference
            if (localStorage.getItem('platequest_dark_mode') === 'true') {
                document.body.classList.add('dark');
                document.getElementById('darkModeBtn').textContent = '☀️ Light Mode';
            }

            // Auto-detect system dark mode preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                if (!localStorage.getItem('platequest_dark_mode')) {
                    document.body.classList.add('dark');
                    document.getElementById('darkModeBtn').textContent = '☀️ Light Mode';
                }
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 's':
                            e.preventDefault();
                            shareTrip();
                            break;
                        case 'l':
                            e.preventDefault();
                            loadSharedTrip();
                            break;
                        case 'r':
                            e.preventDefault();
                            if (confirm('Reset current trip?')) {
                                resetTrip();
                            }
                            break;
                    }
                }
            });
        });

        function startGame() {
            splash.style.display = 'none';
            game.style.display = 'block';
            loadProfiles();
            renderStates();
        }

        // Game Mode Functions
        function updateGameModeUI() {
            const mode = gameModes[currentGameMode];
            
            // Update body class for styling
            document.body.className = document.body.className.replace(/\b\w+-mode-active\b/g, '');
            document.body.classList.add(`${currentGameMode}-mode-active`);
            
            // Update UI based on mode
            if (mode.allowMultipleContributors) {
                showCollaborativeFeatures();
            } else {
                hideCollaborativeFeatures();
            }
            
            if (mode.trackBestTimes) {
                showChallengeFeatures();
            } else {
                hideChallengeFeatures();
            }
            
            // Update game title to reflect mode
            updateGameTitle();
        }

        function showCollaborativeFeatures() {
            // Add contributor tracking
            let contributorSection = document.getElementById('contributorSection');
            if (!contributorSection) {
                contributorSection = document.createElement('div');
                contributorSection.id = 'contributorSection';
                contributorSection.className = 'contributor-section';
                contributorSection.innerHTML = `
                    <h4>👥 Family Contributors</h4>
                    <div id="contributorList"></div>
                    <button class="btn btn-secondary" onclick="addContributor()" style="margin-top: 10px;">+ Add Family Member</button>
                `;
                
                // Insert after score section
                const scoreSection = document.querySelector('.score-section');
                if (scoreSection) {
                    scoreSection.insertAdjacentElement('afterend', contributorSection);
                }
            }
            updateContributorList();
        }

        function hideCollaborativeFeatures() {
            const contributorSection = document.getElementById('contributorSection');
            if (contributorSection) {
                contributorSection.remove();
            }
        }

        function showChallengeFeatures() {
            // Add challenge statistics
            let challengeSection = document.getElementById('challengeSection');
            if (!challengeSection) {
                challengeSection = document.createElement('div');
                challengeSection.id = 'challengeSection';
                challengeSection.className = 'challenge-section';
                challengeSection.innerHTML = `
                    <h4>🏆 Challenge Statistics</h4>
                    <div class="challenge-stats">
                        <div class="stat-card">
                            <div class="stat-label">Personal Best</div>
                            <div class="stat-value" id="personalBest">${getPersonalBest()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Current Time</div>
                            <div class="stat-value" id="currentTime">${getCurrentTripTime()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">States/Day Avg</div>
                            <div class="stat-value" id="dailyAverage">${getDailyAverage()}</div>
                        </div>
                    </div>
                `;
                
                // Insert after score section
                const scoreSection = document.querySelector('.score-section');
                if (scoreSection) {
                    scoreSection.insertAdjacentElement('afterend', challengeSection);
                }
            }
            
            // Start timing
            startChallengeTimer();
        }

        function hideChallengeFeatures() {
            const challengeSection = document.getElementById('challengeSection');
            if (challengeSection) {
                challengeSection.remove();
            }
            stopChallengeTimer();
        }

        // Challenge mode timing functions
        function startChallengeTimer() {
            const tripKey = `profile_${currentProfile}_trip_${currentTrip}`;
            const startTimeKey = `${tripKey}_startTime`;
            
            // Get or set start time
            challengeStartTime = localStorage.getItem(startTimeKey);
            if (!challengeStartTime) {
                challengeStartTime = Date.now();
                localStorage.setItem(startTimeKey, challengeStartTime);
            } else {
                challengeStartTime = parseInt(challengeStartTime);
            }
            
            // Update timer every minute
            challengeTimer = setInterval(updateChallengeTimer, 60000);
            updateChallengeTimer(); // Initial update
        }

        function stopChallengeTimer() {
            if (challengeTimer) {
                clearInterval(challengeTimer);
                challengeTimer = null;
            }
        }

        function updateChallengeTimer() {
            const currentTimeElement = document.getElementById('currentTime');
            if (currentTimeElement && challengeStartTime) {
                const elapsed = Date.now() - challengeStartTime;
                const days = Math.floor(elapsed / (1000 * 60 * 60 * 24));
                const hours = Math.floor((elapsed % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                currentTimeElement.textContent = `${days}d ${hours}h`;
            }
        }

        function getPersonalBest() {
            const bestKey = `profile_${currentProfile}_personalBest`;
            const best = localStorage.getItem(bestKey);
            return best ? `${best} days` : 'None';
        }

        function getCurrentTripTime() {
            return challengeStartTime ? 'Tracking...' : 'Not started';
        }

        function getDailyAverage() {
            if (!challengeStartTime) return '0';
            const elapsed = Date.now() - challengeStartTime;
            const days = elapsed / (1000 * 60 * 60 * 24);
            const average = selectedStates.length / Math.max(days, 1);
            return average.toFixed(1);
        }

        // Collaborative mode functions
        function getCurrentContributor() {
            // In collaborative mode, ask who found it
            if (currentGameMode === 'collab') {
                const contributors = getContributors();
                if (contributors.length === 1) {
                    return contributors[0];
                }
                
                // Simple prompt for now - could be enhanced with a modal
                const contributor = prompt(`Who found this state?\n\nContributors: ${contributors.join(', ')}`);
                return contributor && contributors.includes(contributor) ? contributor : contributors[0];
            }
            return currentProfile;
        }

        function getContributors() {
            const tripKey = `profile_${currentProfile}_trip_${currentTrip}_contributors`;
            const contributors = localStorage.getItem(tripKey);
            return contributors ? JSON.parse(contributors) : [currentProfile];
        }

        function addContributor() {
            const name = prompt('Enter family member name:');
            if (name && name.trim()) {
                const contributors = getContributors();
                if (!contributors.includes(name.trim())) {
                    contributors.push(name.trim());
                    const tripKey = `profile_${currentProfile}_trip_${currentTrip}_contributors`;
                    localStorage.setItem(tripKey, JSON.stringify(contributors));
                    updateContributorList();
                }
            }
        }

        function updateContributorList() {
            const listElement = document.getElementById('contributorList');
            if (listElement) {
                const contributors = getContributors();
                listElement.innerHTML = contributors.map(name => 
                    `<span class="contributor-badge">${name}</span>`
                ).join('');
            }
        }

        function addContributorBadge(cardElement, contributor) {
            // Remove existing badge
            const existingBadge = cardElement.querySelector('.contributor-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // Add new badge
            const badge = document.createElement('div');
            badge.className = 'contributor-badge';
            badge.textContent = contributor.charAt(0).toUpperCase();
            badge.title = `Found by ${contributor}`;
            cardElement.appendChild(badge);
        }

        // Profile and trip management
        function createProfile() {
            const name = document.getElementById('newProfileInput').value.trim();
            if (!name) {
                alert('Please enter a profile name!');
                return;
            }
            
            const option = new Option(name, name);
            profileSelect.add(option);
            profileSelect.value = name;
            currentProfile = name;
            
            document.getElementById('newProfileInput').value = '';
            loadTrips();
            updateGameTitle();
        }

        function deleteProfile() {
            if (!currentProfile) {
                alert('Please select a profile to delete!');
                return;
            }
            
            if (!confirm(`Delete profile "${currentProfile}" and all their trips?`)) return;
            
            // Remove all data for this profile
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith(`profile_${currentProfile}_`)) {
                    localStorage.removeItem(key);
                }
            });
            
            loadProfiles();
            selectedStates = [];
            renderStates();
            updateScore();
        }

        function createTrip() {
            if (!currentProfile) {
                alert('Please create or select a profile first!');
                return;
            }
            
            const name = document.getElementById('newTripInput').value.trim();
            if (!name) {
                alert('Please enter a trip name!');
                return;
            }
            
            // Add date suffix
            const date = new Date();
            const suffix = `_${date.getMonth()+1}-${date.getDate()}-${String(date.getFullYear()).slice(-2)}`;
            const fullName = name + suffix;
            
            const option = new Option(fullName, fullName);
            tripSelect.add(option);
            tripSelect.value = fullName;
            currentTrip = fullName;
            
            document.getElementById('newTripInput').value = '';
            selectedStates = [];
            saveStates();
            renderStates();
            updateScore();
            updateGameTitle();
            
            // Initialize challenge timer if in challenge mode
            if (currentGameMode === 'versus') {
                startChallengeTimer();
            }
        }

        function selectProfile() {
            currentProfile = profileSelect.value;
            loadTrips();
            updateGameTitle();
        }

        function selectTrip() {
            currentTrip = tripSelect.value;
            loadStates();
            updateGameTitle();
        }

        function loadProfiles() {
            const profiles = new Set();
            Object.keys(localStorage).forEach(key => {
                const match = key.match(/^profile_(.*?)_trip_/);
                if (match) profiles.add(match[1]);
            });
            
            profileSelect.innerHTML = '<option value="">Select Profile...</option>';
            profiles.forEach(profile => {
                profileSelect.add(new Option(profile, profile));
            });
            
            if (profiles.size) {
                profileSelect.value = Array.from(profiles)[0];
                currentProfile = profileSelect.value;
                loadTrips();
            }
        }

        function loadTrips() {
            if (!currentProfile) return;
            
            const trips = new Set();
            Object.keys(localStorage).forEach(key => {
                const match = key.match(new RegExp(`^profile_${currentProfile}_trip_(.*?)$`));
                if (match && !key.includes('_contributors') && !key.includes('_startTime')) {
                    trips.add(match[1]);
                }
            });
            
            tripSelect.innerHTML = '<option value="">Select Trip...</option>';
            trips.forEach(trip => {
                tripSelect.add(new Option(trip, trip));
            });
            
            if (trips.size) {
                tripSelect.value = Array.from(trips)[0];
                currentTrip = tripSelect.value;
                loadStates();
            }
        }

        function saveStates() {
            if (!currentProfile || !currentTrip) return;
            const key = `profile_${currentProfile}_trip_${currentTrip}`;
            localStorage.setItem(key, JSON.stringify(selectedStates));
        }

        function loadStates() {
            if (!currentProfile || !currentTrip) return;
            const key = `profile_${currentProfile}_trip_${currentTrip}`;
            const saved = localStorage.getItem(key);
            selectedStates = saved ? JSON.parse(saved) : [];
            renderStates();
            updateScore();
            updateGameModeUI();
        }

        function renderStates() {
            statesGrid.innerHTML = '';
            
            statesData.forEach((state, index) => {
                const card = document.createElement('div');
                card.className = 'state-card';
                
                // Check if state is selected (handle both old string format and new object format)
                let isSelected = false;
                let foundBy = null;
                
                if (currentGameMode === 'collab' && Array.isArray(selectedStates) && selectedStates[0]?.state) {
                    // New collaborative format
                    const stateData = selectedStates.find(s => s.state === state.name);
                    isSelected = !!stateData;
                    foundBy = stateData?.foundBy;
                } else {
                    // Simple string array format
                    isSelected = selectedStates.includes(state.name);
                }
                
                if (isSelected) {
                    card.classList.add('selected');
                    if (currentGameMode === 'collab') {
                        card.classList.add('collaborative');
                    }
                }
                
                // Try to load flag image, fallback to abbreviation
                const flagImg = `flags/${state.abbr.toLowerCase()}.png`;
                
                card.innerHTML = `
                    <div class="state-info">
                        <div class="state-name">${state.name}</div>
                        <div class="state-abbr">${state.abbr}</div>
                    </div>
                    <div class="state-flag">
                        <img src="${flagImg}" alt="${state.abbr} flag" 
                             onerror="this.style.display='none'; this.parentNode.textContent='${state.abbr}';">
                    </div>
                `;
                
                // Add contributor badge if collaborative mode
                if (currentGameMode === 'collab' && foundBy) {
                    addContributorBadge(card, foundBy);
                }
                
                card.addEventListener('click', () => toggleState(state.name, card));
                
                // Add animation delay
                card.style.animationDelay = `${index * 0.02}s`;
                
                statesGrid.appendChild(card);
            });
        }

        function toggleState(stateName, cardElement) {
            if (currentGameMode === 'collab') {
                toggleStateCollaborative(stateName, cardElement);
            } else {
                // Original logic for solo/versus modes
                const index = selectedStates.indexOf(stateName);
                
                if (index > -1) {
                    selectedStates.splice(index, 1);
                    cardElement.classList.remove('selected');
                } else {
                    selectedStates.push(stateName);
                    cardElement.classList.add('selected');
                    
                    // Add celebration effect
                    cardElement.classList.add('celebrating');
                    setTimeout(() => cardElement.classList.remove('celebrating'), 800);
                    
                    // Check for milestones in challenge mode
                    if (currentGameMode === 'versus') {
                        checkChallengeAchievements();
                    }
                    
                    // Check for milestone
                    if (selectedStates.length === 10 || selectedStates.length === 25 || selectedStates.length === 50) {
                        celebrateAchievement(selectedStates.length);
                    }
                }
                
                saveStates();
                updateScore();
            }
        }

        function toggleStateCollaborative(stateName, cardElement) {
            const index = selectedStates.findIndex(s => s.state === stateName);
            
            if (index > -1) {
                // Remove state
                selectedStates.splice(index, 1);
                cardElement.classList.remove('selected', 'collaborative');
                
                // Remove contributor badge
                const badge = cardElement.querySelector('.contributor-badge');
                if (badge) badge.remove();
            } else {
                // Add state with contributor info
                const contributor = getCurrentContributor();
                if (!contributor) return; // User cancelled
                
                selectedStates.push({
                    state: stateName,
                    foundBy: contributor,
                    foundAt: new Date().toISOString(),
                    mode: currentGameMode
                });
                cardElement.classList.add('selected', 'collaborative');
                
                // Add contributor badge
                addContributorBadge(cardElement, contributor);
                
                // Celebration effect
                cardElement.classList.add('celebrating');
                setTimeout(() => cardElement.classList.remove('celebrating'), 800);
                
                // Check for milestone
                if (selectedStates.length === 10 || selectedStates.length === 25 || selectedStates.length === 50) {
                    celebrateAchievement(selectedStates.length);
                }
            }
            
            saveStates();
            updateScore();
        }

        function checkChallengeAchievements() {
            const count = selectedStates.length;
            
            // Check for personal records
            if (count === 50 && challengeStartTime) {
                const elapsed = Date.now() - challengeStartTime;
                const days = Math.floor(elapsed / (1000 * 60 * 60 * 24));
                
                const bestKey = `profile_${currentProfile}_personalBest`;
                const currentBest = localStorage.getItem(bestKey);
                
                if (!currentBest || days < parseInt(currentBest)) {
                    localStorage.setItem(bestKey, days.toString());
                    alert(`🏆 NEW PERSONAL RECORD! Completed in ${days} days!`);
                }
            }
        }

        function updateScore() {
            const count = selectedStates.length;
            const percentage = Math.round((count / 50) * 100);
            
            if (currentGameMode === 'collab') {
                scoreDisplay.textContent = `Family Progress: ${count} of 50 plates (${percentage}%)`;
            } else if (currentGameMode === 'versus') {
                scoreDisplay.textContent = `Challenge Progress: ${count} of 50 plates (${percentage}%)`;
            } else {
                scoreDisplay.textContent = `Found ${count} of 50 plates (${percentage}%)`;
            }
            
            progressFill.style.width = `${percentage}%`;
        }

        function celebrateAchievement(count) {
            const messages = {
                10: "🎉 Great start! 10 states found!",
                25: "🔥 Halfway there! 25 states down!",
                50: "🏆 AMAZING! All 50 states complete!"
            };
            
            if (messages[count]) {
                setTimeout(() => alert(messages[count]), 300);
            }
        }

        function resetTrip() {
            if (!confirm('Reset all spotted plates for this trip?')) return;
            
            selectedStates = [];
            saveStates();
            renderStates();
            updateScore();
            
            // Reset challenge timer if in challenge mode
            if (currentGameMode === 'versus' && currentProfile && currentTrip) {
                const tripKey = `profile_${currentProfile}_trip_${currentTrip}`;
                const startTimeKey = `${tripKey}_startTime`;
                localStorage.removeItem(startTimeKey);
                challengeStartTime = null;
                if (challengeTimer) {
                    clearInterval(challengeTimer);
                    challengeTimer = null;
                }
                showChallengeFeatures(); // Restart timer
            }
        }

        // FIXED: Cloud sharing functions for Realtime Database
        function generateShareCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        async function shareTrip() {
            if (!currentProfile || !currentTrip) {
                alert('Please select a profile and trip first!');
                return;
            }

            if (cloudEnabled) {
                await shareToCloud();
            } else {
                // Fallback to old method
                showExport();
            }
        }

        async function shareToCloud() {
            try {
                showLoading('Creating share link...');
                
                const shareCode = generateShareCode();
                const tripData = {
                    shareCode: shareCode,
                    profile: currentProfile,
                    trip: currentTrip,
                    mode: currentGameMode,
                    states: prepareStatesForSharing(),
                    contributors: currentGameMode === 'collab' ? getContributors() : [currentProfile],
                    createdAt: firebase.database.ServerValue.TIMESTAMP,  // CHANGED: using ServerValue.TIMESTAMP
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                    totalStates: selectedStates.length,
                    isPublic: true
                };

                await database.ref(`sharedTrips/${shareCode}`).set(tripData);  // CHANGED: using database.ref()
                
                hideLoading();
                showShareSuccess(shareCode);
                
            } catch (error) {
                hideLoading();
                console.error('Error sharing trip:', error);
                alert('Failed to create share link. Please try again.');
            }
        }

        function prepareStatesForSharing() {
            if (currentGameMode === 'collab' && Array.isArray(selectedStates) && selectedStates[0]?.state) {
                // Collaborative mode with detailed state info
                return selectedStates;
            } else {
                // Simple string array - convert to detailed format
                return selectedStates.map(state => ({
                    state: typeof state === 'string' ? state : state.state,
                    foundBy: currentProfile,
                    foundAt: new Date().toISOString(),
                    mode: currentGameMode
                }));
            }
        }

        function showShareSuccess(shareCode) {
            const modal = document.createElement('div');
            modal.className = 'share-modal';
            modal.innerHTML = `
                <div class="share-modal-content">
                    <div class="share-header">
                        <h3>🎉 Trip Shared Successfully!</h3>
                        <button class="close-btn" onclick="closeShareModal()">&times;</button>
                    </div>
                    <div class="share-body">
                        <div class="share-code-display">
                            <label>Share Code:</label>
                            <div class="code-box" onclick="copyShareCode('${shareCode}')">
                                <span class="code">${shareCode}</span>
                                <span class="copy-hint">📋 Click to copy</span>
                            </div>
                        </div>
                        
                        <div class="share-url-display">
                            <label>Direct Link:</label>
                            <div class="url-box" onclick="copyShareUrl('${shareCode}')">
                                <span class="url">${window.location.origin}${window.location.pathname}?share=${shareCode}</span>
                                <span class="copy-hint">📋 Click to copy</span>
                            </div>
                        </div>
                        
                        <div class="qr-code-container">
                            <div class="qr-placeholder">
                                <div>QR Code for<br/>${shareCode}</div>
                            </div>
                            <p>Scan QR code to open on mobile</p>
                        </div>
                        
                        <div class="share-actions">
                            <button class="btn btn-primary" onclick="shareViaSystem('${shareCode}')">
                                📱 Share via Apps
                            </button>
                            <button class="btn btn-secondary" onclick="updateSharedTrip('${shareCode}')">
                                🔄 Update Shared Trip
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-backdrop" onclick="closeShareModal()"></div>
            `;
            
            document.body.appendChild(modal);
        }

        async function loadSharedTrip() {
            // Check URL for share parameter
            const urlParams = new URLSearchParams(window.location.search);
            const shareCode = urlParams.get('share');
            
            if (shareCode) {
                await loadTripByShareCode(shareCode);
                return;
            }
            
            // Manual entry
            const code = prompt('Enter a 6-character share code:');
            if (code && code.length === 6) {
                await loadTripByShareCode(code.toUpperCase());
            }
        }

        async function loadTripByShareCode(shareCode) {
            if (!cloudEnabled) {
                alert('Cloud sharing is not available. Please check your internet connection.');
                return;
            }
            
            try {
                showLoading('Loading shared trip...');
                
                const snapshot = await database.ref(`sharedTrips/${shareCode}`).once('value');  // CHANGED: using database.ref()
                
                if (!snapshot.exists()) {
                    hideLoading();
                    alert('Share code not found. Please check the code and try again.');
                    return;
                }
                
                const tripData = snapshot.val();
                
                // Import the trip data
                await importSharedTripData(tripData);
                
                hideLoading();
                
                // Show success message
                alert(`Successfully loaded "${tripData.trip}" from ${tripData.profile}!\n` +
                      `Found ${tripData.totalStates} states in ${tripData.mode} mode.`);
                
                // Clear the URL parameter
                if (window.history && window.history.replaceState) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error loading shared trip:', error);
                alert('Failed to load shared trip. Please try again.');
            }
        }

        async function importSharedTripData(tripData) {
            // Create or select profile
            let profileOption = Array.from(profileSelect.options).find(opt => opt.value === tripData.profile);
            if (!profileOption) {
                profileOption = new Option(tripData.profile, tripData.profile);
                profileSelect.add(profileOption);
            }
            
            profileSelect.value = tripData.profile;
            currentProfile = tripData.profile;
            loadTrips();
            
            // Create unique trip name to avoid conflicts
            const timestamp = new Date().toLocaleDateString();
            const importedTripName = `${tripData.trip} (Imported ${timestamp})`;
            
            let tripOption = new Option(importedTripName, importedTripName);
            tripSelect.add(tripOption);
            
            tripSelect.value = importedTripName;
            currentTrip = importedTripName;
            
            // Set game mode
            currentGameMode = tripData.mode || 'solo';
            const modeRadio = document.querySelector(`input[name="mode"][value="${currentGameMode}"]`);
            if (modeRadio) {
                modeRadio.checked = true;
            }
            
            // Import states
            selectedStates = tripData.states || [];
            
            // Import contributors if collaborative mode
            if (tripData.mode === 'collab' && tripData.contributors) {
                const tripKey = `profile_${currentProfile}_trip_${currentTrip}_contributors`;
                localStorage.setItem(tripKey, JSON.stringify(tripData.contributors));
            }
            
            // Save and update UI
            saveStates();
            renderStates();
            updateScore();
            updateGameModeUI();
            updateGameTitle();
        }

        async function updateSharedTrip(shareCode) {
            if (!cloudEnabled) {
                alert('Cloud sharing is not available.');
                return;
            }
            
            try {
                showLoading('Updating shared trip...');
                
                const updateData = {
                    states: prepareStatesForSharing(),
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP,  // CHANGED: using ServerValue.TIMESTAMP
                    totalStates: selectedStates.length,
                    contributors: currentGameMode === 'collab' ? getContributors() : [currentProfile]
                };
                
                await database.ref(`sharedTrips/${shareCode}`).update(updateData);  // CHANGED: using database.ref()
                
                hideLoading();
                alert('Shared trip updated successfully!');
                
            } catch (error) {
                hideLoading();
                console.error('Error updating shared trip:', error);
                alert('Failed to update shared trip. Please try again.');
            }
        }

        // System sharing API
        function shareViaSystem(shareCode) {
            const url = `${window.location.origin}${window.location.pathname}?share=${shareCode}`;
            const title = `PlateQuest: ${currentTrip}`;
            const text = `Check out my license plate spotting progress! I've found ${selectedStates.length} out of 50 states.`;
            
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: text,
                    url: url
                }).catch(console.error);
            } else {
                // Fallback: copy to clipboard
                copyShareUrl(shareCode);
                alert('Share link copied to clipboard!');
            }
        }

        // Utility functions
        function copyShareCode(shareCode) {
            navigator.clipboard.writeText(shareCode).then(() => {
                showToast('Share code copied!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = shareCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Share code copied!');
            });
        }

        function copyShareUrl(shareCode) {
            const url = `${window.location.origin}${window.location.pathname}?share=${shareCode}`;
            navigator.clipboard.writeText(url).then(() => {
                showToast('Share link copied!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Share link copied!');
            });
        }

        function closeShareModal() {
            const modal = document.querySelector('.share-modal');
            if (modal) {
                modal.remove();
            }
        }

        function showCloudFeatures() {
            // Update button text to indicate cloud features
            const shareBtn = document.getElementById('shareBtn');
            if (shareBtn) {
                shareBtn.innerHTML = '☁️ Share Trip Online';
            }
            
            const importBtn = document.getElementById('importBtn');
            if (importBtn) {
                importBtn.innerHTML = '☁️ Load Shared Trip';
            }
        }

        function showOfflineFeatures() {
            // Keep original offline functionality as fallback
            const shareBtn = document.getElementById('shareBtn');
            if (shareBtn) {
                shareBtn.innerHTML = '📤 Share Trip';
            }
            
            const importBtn = document.getElementById('importBtn');
            if (importBtn) {
                importBtn.innerHTML = '📥 Load Shared Trip';
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            overlay.querySelector('.loading-text').textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        // Legacy export/import functions
        function showExport() {
            if (!currentProfile || !currentTrip) {
                alert('Please select a profile and trip first!');
                return;
            }
            
            const exportData = {
                profile: currentProfile,
                trip: currentTrip,
                mode: currentGameMode,
                states: selectedStates,
                contributors: currentGameMode === 'collab' ? getContributors() : [currentProfile],
                exportedAt: new Date().toISOString()
            };
            
            exportBox.value = JSON.stringify(exportData, null, 2);
            shareSection.style.display = 'block';
        }

        function copyExport() {
            exportBox.select();
            exportBox.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(exportBox.value).then(() => {
                alert('Trip data copied to clipboard!');
            }).catch(() => {
                alert('Please manually copy the text above.');
            });
        }

        function hideShare() {
            shareSection.style.display = 'none';
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            const btn = document.getElementById('darkModeBtn');
            btn.textContent = document.body.classList.contains('dark') ? '☀️ Light Mode' : '🌙 Dark Mode';
            
            // Save preference
            localStorage.setItem('platequest_dark_mode', document.body.classList.contains('dark'));
        }

        function updateGameTitle() {
            const title = document.getElementById('gameTitle');
            if (currentTrip && currentProfile) {
                const mode = gameModes[currentGameMode];
                title.textContent = `${currentTrip} - ${mode.name}`;
            } else {
                title.textContent = 'PlateQuest Adventure';
            }
        }
    </script>
    <script>
// Force enable cloud features since Firebase test passed
setTimeout(() => {
    cloudEnabled = true;
    showCloudFeatures();
    console.log('🚀 Cloud features force-enabled - Firebase test passed!');
}, 2000);
</script>
</body>
</html>